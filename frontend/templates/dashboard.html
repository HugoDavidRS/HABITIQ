{% extends "base.html" %}

{% block title %}Dashboard - HabitIQ{% endblock %}

{% block content %}
<!-- Welcome + Date -->
<div class="dash-welcome">
    <div class="dash-welcome-left">
        <h1 class="dash-greeting" id="greeting">Buenos dias, {{ current_user.username }}</h1>
        <p class="dash-date">{{ today.strftime('%A, %d de %B %Y') }}</p>
    </div>
    <a href="{{ url_for('create_habit') }}" class="btn btn-primary">
        <i class="fas fa-plus"></i> Nuevo Habito
    </a>
</div>

<!-- Progress Overview -->
<div class="dash-progress-section">
    <div class="dash-progress-ring-card">
        <div class="progress-ring-container">
            <svg class="progress-ring" viewBox="0 0 120 120">
                <circle class="progress-ring-bg" cx="60" cy="60" r="52" />
                <circle class="progress-ring-fill" cx="60" cy="60" r="52" 
                        stroke-dasharray="326.73" 
                        stroke-dashoffset="{{ 326.73 - (326.73 * (completed_today / total_habits * 100) / 100) if total_habits > 0 else 326.73 }}" />
            </svg>
            <div class="progress-ring-text">
                <span class="progress-percent" id="progress-percent">{{ ((completed_today / total_habits * 100)|round|int) if total_habits > 0 else 0 }}%</span>
                <span class="progress-label">completado</span>
            </div>
        </div>
        <div class="progress-info">
            <h3>Progreso de Hoy</h3>
            <p><span id="completed-today">{{ completed_today }}</span> de {{ total_habits }} habitos</p>
            {% if total_habits > 0 and completed_today == total_habits %}
                <span class="progress-badge perfect"><i class="fas fa-crown"></i> Dia perfecto</span>
            {% elif completed_today > 0 %}
                <span class="progress-badge going"><i class="fas fa-bolt"></i> Sigue asi</span>
            {% else %}
                <span class="progress-badge start"><i class="fas fa-play"></i> Empieza tu dia</span>
            {% endif %}
        </div>
    </div>

    <div class="dash-stats-grid">
        <div class="dash-stat-card">
            <div class="dash-stat-icon" style="background:rgba(99,102,241,0.12);color:#818cf8;">
                <i class="fas fa-list-check"></i>
            </div>
            <div class="dash-stat-info">
                <span class="dash-stat-num" id="total-habits">{{ total_habits }}</span>
                <span class="dash-stat-label">Habitos Totales</span>
            </div>
        </div>
        <div class="dash-stat-card">
            <div class="dash-stat-icon" style="background:rgba(16,185,129,0.12);color:#10b981;">
                <i class="fas fa-check-double"></i>
            </div>
            <div class="dash-stat-info">
                <span class="dash-stat-num">{{ active_habits }}</span>
                <span class="dash-stat-label">Activos</span>
            </div>
        </div>
        <div class="dash-stat-card">
            <div class="dash-stat-icon" style="background:rgba(245,158,11,0.12);color:#f59e0b;">
                <i class="fas fa-fire"></i>
            </div>
            <div class="dash-stat-info">
                <span class="dash-stat-num">{{ best_streak_habit.best_streak if best_streak_habit else 0 }}</span>
                <span class="dash-stat-label">Mejor Racha</span>
            </div>
        </div>
        <div class="dash-stat-card">
            <div class="dash-stat-icon" style="background:rgba(139,92,246,0.12);color:#8b5cf6;">
                <i class="fas fa-tags"></i>
            </div>
            <div class="dash-stat-info">
                <span class="dash-stat-num" id="total-categories">{{ categories|length }}</span>
                <span class="dash-stat-label">Categorias</span>
            </div>
        </div>
    </div>
</div>

<!-- Today's Habits -->
<section class="dash-section">
    <div class="dash-section-header">
        <h2><i class="fas fa-calendar-day"></i> Habitos para Hoy</h2>
        <a href="{{ url_for('habits_app') }}" class="dash-link">Ver todos <i class="fas fa-arrow-right"></i></a>
    </div>

    {% if habits %}
    <div class="dash-today-list">
        {% for habit in habits %}
        <div class="dash-habit-row {% if habit.completed_today %}completed{% endif %}" id="habit-{{ habit.id }}">
            <div class="dash-habit-check">
                <form action="{{ url_for('toggle_complete', habit_id=habit.id) }}" method="POST" class="complete-form">
                    <button type="submit" class="dash-check-btn {% if habit.completed_today %}checked{% endif %}" data-habit-id="{{ habit.id }}">
                        <i class="fas fa-check"></i>
                    </button>
                </form>
            </div>
            <div class="dash-habit-info">
                <h4>{{ habit.name }}</h4>
                {% if habit.description %}
                <p class="dash-habit-desc">{{ habit.description }}</p>
                {% endif %}
            </div>
            <div class="dash-habit-meta">
                <span class="dash-cat-badge category-{{ habit.category }}">{{ habit.category|capitalize }}</span>
                {% if habit.current_streak > 0 %}
                <span class="dash-streak"><i class="fas fa-fire"></i> <span class="streak-count">{{ habit.current_streak }}</span></span>
                {% endif %}
            </div>
            <a href="{{ url_for('edit_habit', habit_id=habit.id) }}" class="btn-icon" title="Editar">
                <i class="fas fa-pen"></i>
            </a>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="dash-empty">
        <div class="dash-empty-icon"><i class="fas fa-plus-circle"></i></div>
        <h4>Empieza creando tu primer habito</h4>
        <p>Define que habitos quieres mejorar y comienza a seguir tu progreso.</p>
        <a href="{{ url_for('create_habit') }}" class="btn btn-primary"><i class="fas fa-plus"></i> Crear Habito</a>
    </div>
    {% endif %}
</section>

<!-- Categories -->
{% if categories %}
<section class="dash-section">
    <div class="dash-section-header">
        <h2><i class="fas fa-th-large"></i> Por Categoria</h2>
    </div>
    <div class="dash-categories-grid">
        {% for category, category_habits in categories.items() %}
        <div class="dash-category-card">
            <div class="dash-category-top">
                <span class="dash-cat-badge category-{{ category }}">
                    <i class="fas fa-{{ 'heartbeat' if category == 'health' else 'dumbbell' if category == 'fitness' else 'book' if category == 'learning' else 'briefcase' if category == 'productivity' else 'brain' if category == 'mindfulness' else 'piggy-bank' if category == 'finance' else 'users' if category == 'social' else 'folder' }}"></i>
                    {{ category|capitalize }}
                </span>
                <span class="dash-cat-count">{{ category_habits|length }}</span>
            </div>
            <div class="dash-category-habits">
                {% for habit in category_habits[:4] %}
                <div class="dash-cat-habit {% if habit.completed_today %}done{% endif %}" id="cat-habit-{{ habit.id }}">
                    <span class="habit-name">{{ habit.name }}</span>
                    {% if habit.completed_today %}
                    <i class="fas fa-check-circle completed-icon"></i>
                    {% endif %}
                </div>
                {% endfor %}
                {% if category_habits|length > 4 %}
                <span class="dash-cat-more">+{{ category_habits|length - 4 }} mas</span>
                {% endif %}
            </div>
            {% set completed_count = category_habits|selectattr('completed_today')|list|length %}
            <div class="dash-category-progress">
                <div class="dash-cat-bar">
                    <div class="dash-cat-bar-fill" style="width: {{ ((completed_count / category_habits|length) * 100)|round|int if category_habits|length > 0 else 0 }}%"></div>
                </div>
                <span class="dash-cat-percent completion-rate">{{ ((completed_count / category_habits|length) * 100)|round|int if category_habits|length > 0 else 0 }}%</span>
            </div>
        </div>
        {% endfor %}
    </div>
</section>
{% endif %}

<!-- Charts -->
<div class="dash-chart-section">
    <div class="dash-chart-card">
        <h3><i class="fas fa-chart-area"></i> Completaciones (30 dias)</h3>
        <div class="chart-container">
            <canvas id="completionsChart"></canvas>
        </div>
    </div>
    <div class="dash-chart-card">
        <h3><i class="fas fa-th"></i> Actividad Anual</h3>
        <div class="heatmap-container" id="heatmapContainer"></div>
        <div style="display:flex;align-items:center;gap:0.4rem;margin-top:0.5rem;justify-content:flex-end;">
            <span style="font-size:0.7rem;color:var(--text-muted)">Menos</span>
            <span class="heatmap-cell" style="width:12px;height:12px;display:inline-block"></span>
            <span class="heatmap-cell level-1" style="width:12px;height:12px;display:inline-block"></span>
            <span class="heatmap-cell level-2" style="width:12px;height:12px;display:inline-block"></span>
            <span class="heatmap-cell level-3" style="width:12px;height:12px;display:inline-block"></span>
            <span class="heatmap-cell level-4" style="width:12px;height:12px;display:inline-block"></span>
            <span style="font-size:0.7rem;color:var(--text-muted)">Mas</span>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<section class="dash-section">
    <div class="dash-section-header">
        <h2><i class="fas fa-bolt"></i> Acciones Rapidas</h2>
    </div>
    <div class="dash-actions">
        <a href="{{ url_for('create_habit') }}" class="dash-action-card">
            <div class="dash-action-icon"><i class="fas fa-plus-circle"></i></div>
            <span>Nuevo Habito</span>
        </a>
        <a href="{{ url_for('habits_app') }}" class="dash-action-card">
            <div class="dash-action-icon"><i class="fas fa-th-list"></i></div>
            <span>Ver Todos</span>
        </a>
        <a href="{{ url_for('friends_page') }}" class="dash-action-card">
            <div class="dash-action-icon"><i class="fas fa-users"></i></div>
            <span>Amigos</span>
        </a>
        <a href="{{ url_for('leaderboard') }}" class="dash-action-card">
            <div class="dash-action-icon"><i class="fas fa-ranking-star"></i></div>
            <span>Ranking</span>
        </a>
    </div>
</section>

<!-- Motivation -->
<div class="dash-motivation">
    <i class="fas fa-quote-left"></i>
    <p>"Los habitos exitosos se construyen un dia a la vez. Cada marca que haces hoy es una inversion en tu futuro."</p>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Greeting based on time
    const hour = new Date().getHours();
    const greetEl = document.getElementById('greeting');
    let greet = 'Buenas noches';
    if (hour >= 5 && hour < 12) greet = 'Buenos dias';
    else if (hour >= 12 && hour < 19) greet = 'Buenas tardes';
    if (greetEl) greetEl.textContent = greet + ', {{ current_user.username }}';

    // AJAX completion
    document.querySelectorAll('.complete-form').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const btn = this.querySelector('.dash-check-btn');
            const row = this.closest('.dash-habit-row');
            const habitId = btn.dataset.habitId;
            const streakEl = row.querySelector('.streak-count');

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            fetch(this.action, {
                method: 'POST',
                headers: { 'X-Requested-With': 'XMLHttpRequest', 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams(new FormData(this))
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    btn.classList.toggle('checked');
                    row.classList.toggle('completed');

                    if (streakEl) {
                        streakEl.textContent = data.current_streak;
                    } else if (data.current_streak > 0) {
                        const meta = row.querySelector('.dash-habit-meta');
                        if (meta) {
                            const s = document.createElement('span');
                            s.className = 'dash-streak';
                            s.innerHTML = '<i class="fas fa-fire"></i> <span class="streak-count">' + data.current_streak + '</span>';
                            meta.appendChild(s);
                        }
                    }

                    // Update category view
                    const catHabit = document.getElementById('cat-habit-' + habitId);
                    if (catHabit) {
                        if (data.completed) {
                            catHabit.classList.add('done');
                            if (!catHabit.querySelector('.completed-icon')) {
                                const ic = document.createElement('i');
                                ic.className = 'fas fa-check-circle completed-icon';
                                catHabit.appendChild(ic);
                            }
                        } else {
                            catHabit.classList.remove('done');
                            const ic = catHabit.querySelector('.completed-icon');
                            if (ic) ic.remove();
                        }
                    }

                    // Update counter
                    const counter = document.getElementById('completed-today');
                    if (counter) {
                        let c = parseInt(counter.textContent);
                        c = data.completed ? c + 1 : Math.max(0, c - 1);
                        counter.textContent = c;
                    }

                    // Update progress ring
                    updateProgressRing();

                    // Update category bars
                    document.querySelectorAll('.dash-category-card').forEach(card => {
                        const items = card.querySelectorAll('.dash-cat-habit');
                        const done = card.querySelectorAll('.dash-cat-habit.done').length;
                        const pct = items.length > 0 ? Math.round((done / items.length) * 100) : 0;
                        const fill = card.querySelector('.dash-cat-bar-fill');
                        const label = card.querySelector('.dash-cat-percent');
                        if (fill) fill.style.width = pct + '%';
                        if (label) label.textContent = pct + '%';
                    });

                    // Notification
                    showNotif(data.completed ? 'Completado' : 'Removido', data.habit_name, data.completed ? 'success' : 'info');

                    if (data.completed) confetti();
                }
            })
            .catch(() => showNotif('Error', 'No se pudo actualizar', 'error'))
            .finally(() => { btn.disabled = false; btn.innerHTML = '<i class="fas fa-check"></i>'; });
        });
    });

    function updateProgressRing() {
        const total = parseInt(document.getElementById('total-habits').textContent) || 1;
        const done = parseInt(document.getElementById('completed-today').textContent) || 0;
        const pct = Math.round((done / total) * 100);
        const circle = document.querySelector('.progress-ring-fill');
        const label = document.getElementById('progress-percent');
        if (circle) circle.style.strokeDashoffset = 326.73 - (326.73 * pct / 100);
        if (label) label.textContent = pct + '%';
    }

    function showNotif(title, msg, type) {
        const n = document.createElement('div');
        n.className = 'flash-message flash-' + type;
        n.style.cssText = 'position:fixed;top:90px;right:20px;z-index:9999;animation:slideIn .3s ease;max-width:350px;';
        n.innerHTML = '<span><strong>' + title + '</strong> â€” ' + msg + '</span><button class="flash-close" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>';
        document.body.appendChild(n);
        setTimeout(() => { if (n.parentNode) n.remove(); }, 3000);
    }

    function confetti() {
        const colors = ['#6366f1','#8b5cf6','#10b981','#f59e0b','#f43f5e'];
        for (let i = 0; i < 25; i++) {
            const c = document.createElement('div');
            c.style.cssText = 'position:fixed;width:8px;height:8px;border-radius:' + (Math.random()>.5?'50%':'2px') + ';background:' + colors[Math.floor(Math.random()*colors.length)] + ';left:' + (Math.random()*100) + 'vw;top:-10px;z-index:9998;pointer-events:none;';
            document.body.appendChild(c);
            c.animate([
                { transform: 'translateY(0) rotate(0)', opacity: 1 },
                { transform: 'translateY(' + window.innerHeight + 'px) rotate(' + (Math.random()*720) + 'deg)', opacity: 0 }
            ], { duration: 1200 + Math.random()*800, easing: 'cubic-bezier(.1,.8,.9,.2)' }).onfinish = () => c.remove();
        }
    }

    // ===== CHARTS =====

    // Completions Line Chart
    fetch('/api/chart/completions').then(r=>r.json()).then(data => {
        const ctx = document.getElementById('completionsChart');
        if (!ctx) return;
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.map(d => d.date),
                datasets: [{
                    label: 'Completaciones',
                    data: data.map(d => d.count),
                    borderColor: '#818cf8',
                    backgroundColor: 'rgba(129,140,248,0.1)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 2,
                    pointHoverRadius: 5,
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: {
                        ticks: { color: '#64748b', font: { size: 10 }, maxTicksLimit: 10 },
                        grid: { color: 'rgba(51,65,85,0.3)' }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: { color: '#64748b', font: { size: 10 }, stepSize: 1 },
                        grid: { color: 'rgba(51,65,85,0.3)' }
                    }
                }
            }
        });
    }).catch(()=>{});

    // Heatmap
    fetch('/api/chart/heatmap').then(r=>r.json()).then(data => {
        const container = document.getElementById('heatmapContainer');
        if (!container) return;
        const grid = document.createElement('div');
        grid.className = 'heatmap-grid';

        const dates = Object.keys(data).sort();
        const maxVal = Math.max(...Object.values(data), 1);

        dates.forEach(dateStr => {
            const count = data[dateStr];
            const cell = document.createElement('div');
            cell.className = 'heatmap-cell';
            if (count > 0) {
                const ratio = count / maxVal;
                if (ratio <= 0.25) cell.classList.add('level-1');
                else if (ratio <= 0.5) cell.classList.add('level-2');
                else if (ratio <= 0.75) cell.classList.add('level-3');
                else cell.classList.add('level-4');
            }
            cell.title = dateStr + ': ' + count + ' completaciones';
            grid.appendChild(cell);
        });

        container.appendChild(grid);
    }).catch(()=>{});

    // Auto refresh every 30s
    setInterval(() => {
        fetch('/api/dashboard/stats').then(r=>r.json()).then(d => {
            document.getElementById('total-habits').textContent = d.total_habits;
            document.getElementById('completed-today').textContent = d.completed_today;
            updateProgressRing();
        }).catch(()=>{});
    }, 30000);
});
</script>
{% endblock %}
